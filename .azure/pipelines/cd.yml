# whenever we push to main, master or release branch.

trigger:
  tags:
    include:
      - v*.*.*

variables:
    - group: release-variables_plugin
    - name: taggedVersion
      value: ${{ replace(variables['Build.SourceBranchName'], 'v') }}

pool:
  vmImage: "ubuntu-latest"

steps:
  - task: NodeTool@0
    inputs:
      versionSpec: "16.x"
    displayName: "Install Node.js"

  - script: |
      npm ci
    displayName: "Install dependencies"

  - script: |
      npm run build
    displayName: "Build project"

  - task: Npm@1
    displayName: 'Set version in Package.json to $(taggedVersion)'
    inputs:
      command: 'custom'
      customCommand: '--no-git-tag-version version $(taggedVersion)' 
  - task: DeleteFiles@1
    inputs:
      SourceFolder: 
      Contents: '**/node_modules/*'


  - task: Npm@1
    displayName: 'Publish package to internal feed'
    inputs:
      command: 'publish'
      verbose: true
      publishRegistry: 'useFeed'
      publishFeed: '$(publishFeed)'

